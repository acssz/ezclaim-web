"use client";

import { createContext, useCallback, useContext, useMemo, useState } from "react";

export type Lang = "zh" | "en" | "de-CH" | "fr" | "it";

type Ctx = {
  lang: Lang;
  t: (key: string) => string;
  setLang: (l: Lang) => void;
};

const I18nContext = createContext<Ctx | null>(null);

const dict: Record<Lang, Record<string, string>> = {
  zh: {
    brand: "ACSSZ EzClaim",
    welcome: "欢迎使用 ACSSZ 报销系统",
    newClaim: "新建报销单",
    openExisting: "打开已有报销单",
    newClaimPrompt: "想要报销新项目？",
    claimId: "报销单ID",
    passwordOptional: "密码（可选）",
    openClaim: "打开报销单",
    idOrPasswordError: "报销单 ID 不存在或密码错误",
    createTitle: "新建报销单",
    fieldTitle: "标题",
    fieldDescription: "说明",
    fieldAmount: "金额",
    fieldCurrency: "币种",
    fieldExpenseAt: "消费时间",
    fieldRecipient: "收款人",
    payoutInfo: "收款信息",
    payoutIban: "IBAN",
    payoutAccount: "账户号",
    payoutBankName: "开户行",
    payoutSwift: "SWIFT",
    payoutRouting: "Routing Number",
    payoutBankAddress: "银行地址",
    tags: "标签",
    attachments: "附件（发票/小票照片）",
    invoiceReminder: "请务必在附件中上传正规发票，否则审批可能被驳回。",
    password: "访问密码（可选）",
    passwordHint: "可为该报销单设置访问密码。设置后，查看或更新需要输入此密码。",
    passwordConfirm: "再次输入密码",
    passwordMismatch: "两次输入的密码不一致",
    submit: "提交报销单",
    detailTitle: "报销单详情",
    refresh: "刷新",
    process: "流程",
    actions: "操作",
    withdraw: "撤回申请",
    confirmFinish: "确认收款",
    amount: "金额",
    expenseAt: "消费时间",
    createdAt: "创建时间",
    updatedAt: "更新时间",
    recipient: "收款人",
    attachmentsShort: "附件",
    status_UNKNOWN: "待定",
    status_SUBMITTED: "已提交",
    status_APPROVED: "已批准",
    status_PAID: "已支付",
    status_FINISHED: "已完成",
    status_REJECTED: "已拒绝",
    status_PAYMENT_FAILED: "付款失败",
    status_WITHDRAW: "已撤回",
    claimIdNote: "此 ID 类似密码，请妥善保管，不要分享。",
    copy: "复制",
    copied: "已复制",
    enterPassword: "请输入访问密码",
    passwordWrong: "密码错误，请重试",
    cancel: "取消",
    confirm: "确认",
  },
  en: {
    brand: "ACSSZ Reimbursement",
    welcome: "Welcome to the ACSSZ Reimbursement System",
    newClaim: "New Claim",
    openExisting: "Open Existing Claim",
    newClaimPrompt: "Want to submit a new claim?",
    claimId: "Claim ID",
    passwordOptional: "Password (optional)",
    openClaim: "Open Claim",
    idOrPasswordError: "Claim ID does not exist or password is incorrect.",
    createTitle: "Create Claim",
    fieldTitle: "Title",
    fieldDescription: "Description",
    fieldAmount: "Amount",
    fieldCurrency: "Currency",
    fieldExpenseAt: "Expense Time",
    fieldRecipient: "Recipient",
    payoutInfo: "Payout Info",
    payoutIban: "IBAN",
    payoutAccount: "Account Number",
    payoutBankName: "Bank Name",
    payoutSwift: "SWIFT",
    payoutRouting: "Routing Number",
    payoutBankAddress: "Bank Address",
    tags: "Tags",
    attachments: "Attachments (receipt photos)",
    invoiceReminder: "Please upload the official invoice as an attachment before submitting, otherwise the claim may be rejected.",
    password: "Password (optional)",
    passwordHint: "You can set a password. Viewing or updating later requires it.",
    passwordConfirm: "Confirm password",
    passwordMismatch: "Passwords do not match",
    submit: "Submit Claim",
    detailTitle: "Claim Detail",
    refresh: "Refresh",
    process: "Process",
    actions: "Actions",
    withdraw: "Withdraw",
    confirmFinish: "Confirm received",
    amount: "Amount",
    expenseAt: "Expense Time",
    createdAt: "Created At",
    updatedAt: "Updated At",
    recipient: "Recipient",
    attachmentsShort: "Attachments",
    status_UNKNOWN: "Unknown",
    status_SUBMITTED: "Submitted",
    status_APPROVED: "Approved",
    status_PAID: "Paid",
    status_FINISHED: "Finished",
    status_REJECTED: "Rejected",
    status_PAYMENT_FAILED: "Payment Failed",
    status_WITHDRAW: "Withdrawn",
    claimIdNote: "Treat this ID like a password. Keep it private.",
    copy: "Copy",
    copied: "Copied",
    enterPassword: "Enter password",
    passwordWrong: "Incorrect password. Please try again.",
    cancel: "Cancel",
    confirm: "Confirm",
  },
  "de-CH": {
    brand: "ACSSZ Spesen",
    welcome: "Willkommen beim ACSSZ-Spesensystem",
    newClaim: "Neue Spesen",
    openExisting: "Vorhandene Spesen öffnen",
    newClaimPrompt: "Neue Spesen einreichen?",
    claimId: "Spesen-ID",
    passwordOptional: "Passwort (optional)",
    openClaim: "Spesen öffnen",
    idOrPasswordError: "Spesen-ID existiert nicht oder Passwort ist falsch.",
    createTitle: "Spesen erfassen",
    fieldTitle: "Titel",
    fieldDescription: "Beschreibung",
    fieldAmount: "Betrag",
    fieldCurrency: "Währung",
    fieldExpenseAt: "Ausgabedatum",
    fieldRecipient: "Empfänger/in",
    payoutInfo: "Auszahlungsinfo",
    payoutIban: "IBAN",
    payoutAccount: "Kontonummer",
    payoutBankName: "Bankname",
    payoutSwift: "SWIFT",
    payoutRouting: "Routing-Nummer",
    payoutBankAddress: "Bankadresse",
    tags: "Tags",
    attachments: "Beilagen (Belege/Fotos)",
    invoiceReminder: "Bitte laden Sie vor dem Einreichen die offizielle Rechnung als Anhang hoch, sonst kann die Spesenanfrage abgelehnt werden.",
    password: "Passwort (optional)",
    passwordHint: "Sie können ein Passwort setzen. Ansicht/Änderung erfordert es.",
    passwordConfirm: "Passwort bestätigen",
    passwordMismatch: "Passwörter stimmen nicht überein",
    submit: "Spesen einreichen",
    detailTitle: "Spesendetails",
    refresh: "Aktualisieren",
    process: "Ablauf",
    actions: "Aktionen",
    withdraw: "Zurückziehen",
    confirmFinish: "Erhalt bestätigen",
    amount: "Betrag",
    expenseAt: "Ausgabedatum",
    createdAt: "Erstellt am",
    updatedAt: "Aktualisiert am",
    recipient: "Empfänger/in",
    attachmentsShort: "Beilagen",
    status_UNKNOWN: "Unbekannt",
    status_SUBMITTED: "Eingereicht",
    status_APPROVED: "Genehmigt",
    status_PAID: "Bezahlt",
    status_FINISHED: "Abgeschlossen",
    status_REJECTED: "Abgelehnt",
    status_PAYMENT_FAILED: "Zahlung fehlgeschlagen",
    status_WITHDRAW: "Zurückgezogen",
    claimIdNote: "Behandeln Sie diese ID wie ein Passwort. Nicht teilen.",
    copy: "Kopieren",
    copied: "Kopiert",
    enterPassword: "Passwort eingeben",
    passwordWrong: "Falsches Passwort. Bitte erneut versuchen.",
    cancel: "Abbrechen",
    confirm: "Bestätigen",
  },
  fr: {
    brand: "Remboursement ACSSZ",
    welcome: "Bienvenue sur le système de remboursement ACSSZ",
    newClaim: "Nouvelle note",
    openExisting: "Ouvrir une note existante",
    newClaimPrompt: "Vous voulez créer une nouvelle note ?",
    claimId: "ID de note",
    passwordOptional: "Mot de passe (optionnel)",
    openClaim: "Ouvrir la note",
    idOrPasswordError: "L'ID de note n'existe pas ou le mot de passe est incorrect.",
    createTitle: "Créer une note",
    fieldTitle: "Titre",
    fieldDescription: "Description",
    fieldAmount: "Montant",
    fieldCurrency: "Devise",
    fieldExpenseAt: "Date de dépense",
    fieldRecipient: "Bénéficiaire",
    payoutInfo: "Infos de paiement",
    payoutIban: "IBAN",
    payoutAccount: "Numéro de compte",
    payoutBankName: "Banque",
    payoutSwift: "SWIFT",
    payoutRouting: "Numéro de routage",
    payoutBankAddress: "Adresse de la banque",
    tags: "Tags",
    attachments: "Pièces jointes (reçus)",
    invoiceReminder: "Veuillez joindre la facture officielle dans les fichiers avant l'envoi, sans quoi la demande pourrait être refusée.",
    password: "Mot de passe (optionnel)",
    passwordHint: "Vous pouvez définir un mot de passe. Requis pour consulter/modifier.",
    passwordConfirm: "Confirmer le mot de passe",
    passwordMismatch: "Les mots de passe ne correspondent pas",
    submit: "Soumettre la note",
    detailTitle: "Détails de la note",
    refresh: "Actualiser",
    process: "Processus",
    actions: "Actions",
    withdraw: "Retirer",
    confirmFinish: "Confirmer reçu",
    amount: "Montant",
    expenseAt: "Date de dépense",
    createdAt: "Créé le",
    updatedAt: "Mis à jour le",
    recipient: "Bénéficiaire",
    attachmentsShort: "Pièces jointes",
    status_UNKNOWN: "Inconnu",
    status_SUBMITTED: "Soumis",
    status_APPROVED: "Approuvé",
    status_PAID: "Payé",
    status_FINISHED: "Terminé",
    status_REJECTED: "Rejeté",
    status_PAYMENT_FAILED: "Paiement échoué",
    status_WITHDRAW: "Retiré",
    claimIdNote: "Considérez cet ID comme un mot de passe. Ne le partagez pas.",
    copy: "Copier",
    copied: "Copié",
    enterPassword: "Saisir le mot de passe",
    passwordWrong: "Mot de passe incorrect. Veuillez réessayer.",
    cancel: "Annuler",
    confirm: "Confirmer",
  },
  it: {
    brand: "Rimborsi ACSSZ",
    welcome: "Benvenuto nel sistema di rimborsi ACSSZ",
    newClaim: "Nuova nota",
    openExisting: "Apri una nota esistente",
    newClaimPrompt: "Vuoi creare una nuova nota?",
    claimId: "ID nota",
    passwordOptional: "Password (opzionale)",
    openClaim: "Apri la nota",
    idOrPasswordError: "L'ID nota non esiste o la password è errata.",
    createTitle: "Crea nota",
    fieldTitle: "Titolo",
    fieldDescription: "Descrizione",
    fieldAmount: "Importo",
    fieldCurrency: "Valuta",
    fieldExpenseAt: "Data della spesa",
    fieldRecipient: "Beneficiario",
    payoutInfo: "Informazioni di pagamento",
    payoutIban: "IBAN",
    payoutAccount: "Numero di conto",
    payoutBankName: "Banca",
    payoutSwift: "SWIFT",
    payoutRouting: "Routing Number",
    payoutBankAddress: "Indirizzo della banca",
    tags: "Tag",
    attachments: "Allegati (ricevute/foto)",
    invoiceReminder: "Ricordati di caricare la fattura ufficiale tra gli allegati prima di inviare, altrimenti la richiesta potrebbe essere rifiutata.",
    password: "Password (opzionale)",
    passwordHint: "Puoi impostare una password. Sarà richiesta per vedere/modificare in seguito.",
    passwordConfirm: "Conferma password",
    passwordMismatch: "Le password non corrispondono",
    submit: "Invia nota",
    detailTitle: "Dettagli della nota",
    refresh: "Aggiorna",
    process: "Processo",
    actions: "Azioni",
    withdraw: "Ritira",
    confirmFinish: "Conferma ricevuto",
    amount: "Importo",
    expenseAt: "Data della spesa",
    createdAt: "Creato il",
    updatedAt: "Aggiornato il",
    recipient: "Beneficiario",
    attachmentsShort: "Allegati",
    status_UNKNOWN: "Sconosciuto",
    status_SUBMITTED: "Inviata",
    status_APPROVED: "Approvata",
    status_PAID: "Pagata",
    status_FINISHED: "Completata",
    status_REJECTED: "Rifiutata",
    status_PAYMENT_FAILED: "Pagamento fallito",
    status_WITHDRAW: "Ritirata",
    claimIdNote: "Tratta questo ID come una password. Mantienilo privato.",
    copy: "Copia",
    copied: "Copiato",
    enterPassword: "Inserisci la password",
    passwordWrong: "Password errata. Riprova.",
    cancel: "Annulla",
    confirm: "Conferma",
  },
};

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [lang, setLangState] = useState<Lang>(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem('lang') as Lang | null;
      if (saved && saved in dict) return saved;
      const nav = navigator.language.toLowerCase();
      if (nav.startsWith('de')) return 'de-CH';
      if (nav.startsWith('fr')) return 'fr';
      if (nav.startsWith('en')) return 'en';
      if (nav.startsWith('it')) return 'it';
    }
    return 'zh';
  });
  const setLang = (l: Lang) => {
    setLangState(l);
    try { localStorage.setItem('lang', l); } catch {}
  };
  const t = useCallback((key: string) => dict[lang][key] ?? key, [lang]);
  const value = useMemo(() => ({ lang, t, setLang }), [lang, t]);
  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
}
